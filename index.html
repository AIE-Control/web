<script>
    // Initialize engine state
    let engineState = 0;
    
    // DOM Elements
    const rpmElement = document.getElementById('temperature');
    const voltageElement = document.getElementById('humidity');
    const timestampElements = document.querySelectorAll('.timestamp');
    const toggleButton = document.getElementById('toggleButton');

    async function fetchSensorData() {
        try {
            const response = await fetch('/data/sensor-data.csv?t=' + Date.now());
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const textData = await response.text();
            const readings = textData.trim().split('\n').filter(line => line);
            
            if (readings.length > 0) {
                const latestReading = readings[readings.length - 1].split(',');
                
                if (latestReading.length === 3) {
                    // Update display values with number formatting
                    rpmElement.textContent = parseFloat(latestReading[1]).toFixed(2);
                    voltageElement.textContent = `${parseFloat(latestReading[2]).toFixed(2)} V`;
                    
                    // Update timestamps
                    const formattedTime = new Date(latestReading[0] * 1000).toLocaleTimeString();
                    timestampElements.forEach(el => {
                        el.textContent = `Last update: ${formattedTime}`;
                    });
                }
            }
        } catch (error) {
            console.error('Data fetch error:', error);
            voltageElement.textContent = '--';
            rpmElement.textContent = '--';
            timestampElements.forEach(el => {
                el.textContent = 'Last update: failed';
            });
        }
    }

    async function toggleEngine() {
        try {
            const newState = engineState === 0 ? 1 : 0;
            const response = await fetch('/update-engine.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ engine: newState })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            engineState = result.engine;
            toggleButton.style.backgroundColor = engineState ? "green" : "red";
            toggleButton.textContent = engineState ? "Engine ON" : "Engine OFF";
            
        } catch (error) {
            console.error('Toggle failed:', error);
            alert('Engine control update failed. Please try again.');
        }
    }

    // Initial data load
    fetchSensorData();
    
    // Set up periodic updates
    const updateInterval = setInterval(fetchSensorData, 2000);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        clearInterval(updateInterval);
    });
</script>
